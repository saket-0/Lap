<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Inventory Management</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for the ledger */
        #ledger-display::-webkit-scrollbar,
        #inventory-display::-webkit-scrollbar {
            width: 6px;
        }
        #ledger-display::-webkit-scrollbar-track,
        #inventory-display::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        #ledger-display::-webkit-scrollbar-thumb,
        #inventory-display::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 3px;
        }
        #ledger-display::-webkit-scrollbar-thumb:hover,
        #inventory-display::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">

    <div class="container mx-auto max-w-7xl p-4 md:p-8">
        
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-indigo-600">Blockchain Inventory Demo</h1>
            <p class="mt-2 text-lg text-slate-600">
                See how a blockchain provides an immutable, transparent ledger for supply chain management.
                Actions update the "Current Inventory" (the state) and are permanently recorded on the "Blockchain Ledger" (the history).
                <strong class="text-indigo-700">Now with persistent storage!</strong>
            </p>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Column 1: Actions -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- Add Item Form -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-800">1. Add New Item</h2>
                    <p class="text-sm text-slate-500 mb-4">Simulate a supplier adding new products to the system.</p>
                    <form id="add-item-form" class="space-y-4">
                        <div>
                            <label for="add-product-id" class="block text-sm font-medium text-slate-700">Product ID (SKU)</label>
                            <input type="text" id="add-product-id" value="SKU-101" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="add-product-name" class="block text-sm font-medium text-slate-700">Product Name</label>
                            <input type="text" id="add-product-name" value="Smart Watch" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="add-quantity" class="block text-sm font-medium text-slate-700">Quantity</label>
                            <input type="number" id="add-quantity" value="100" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="add-to" class="block text-sm font-medium text-slate-700">Add to Location</label>
                            <select id="add-to" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option>Supplier</option>
                                <option>Warehouse</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                            Add Item (Create Transaction)
                        </button>
                    </form>
                </div>

                <!-- Move Item Form -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-800">2. Move Item</h2>
                    <p class="text-sm text-slate-500 mb-4">Simulate moving items between locations in the supply chain.</p>
                    <form id="move-item-form" class="space-y-4">
                        <div>
                            <label for="move-product-id" class="block text-sm font-medium text-slate-700">Product ID (SKU)</label>
                            <select id="move-product-id" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="move-quantity" class="block text-sm font-medium text-slate-700">Quantity</label>
                            <input type="number" id="move-quantity" value="25" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="move-from" class="block text-sm font-medium text-slate-700">From Location</label>
                            <select id="move-from" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option selected>Supplier</option>
                                <option>Warehouse</option>
                                <option>Retailer</option>
                            </select>
                        </div>
                        <div>
                            <label for="move-to" class="block text-sm font-medium text-slate-700">To Location</label>
                            <select id="move-to" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option>Supplier</option>
                                <option selected>Warehouse</option>
                                <option>Retailer</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Move Item (Create Transaction)
                        </button>
                    </form>
                </div>
                
                <!-- Clear Database -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-800">Database Options</h2>
                    <p class="text-sm text-slate-500 mb-4">The blockchain is saved in your browser's local storage. You can clear it to reset the demo.</p>
                    <button id="clear-db-button" class="w-full bg-red-600 text-white py-2 px-4 rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        Clear Database & Reset
                    </button>
                </div>

            </div>

            <!-- Column 2: Current Inventory State -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-lg shadow-md sticky top-8">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-800">Current Inventory (The "World State")</h2>
                    <p class="text-sm text-slate-500 mb-4">This is the current "truth" of the inventory, derived by processing all transactions on the blockchain.</p>
                    <div id="inventory-display" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <!-- Inventory will be rendered here by JS -->
                        <p class="text-slate-500">No items in inventory. Add some!</p>
                    </div>
                </div>
            </div>

            <!-- Column 3: Blockchain Ledger -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-800">Blockchain Ledger (Immutable History)</h2>
                    <p class="text-sm text-slate-500 mb-4">A new block is added for every transaction. This log is permanent and verifiable. (Newest block on top).</p>
                    <div id="ledger-display" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <!-- Ledger blocks will be rendered here by JS -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Error Toast -->
    <div id="error-toast" class="fixed bottom-8 right-8 bg-red-600 text-white py-3 px-6 rounded-lg shadow-xl translate-x-[200%] transform transition-transform duration-300 ease-out">
        <span id="error-message"></span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STRUCTURES ---

            // The 'blockchain' is an array of block objects
            let blockchain = [];
            
            // The 'inventory' is the current state, derived from the blockchain.
            // Using a Map for efficient lookups by productId (SKU)
            // Format: Map<productId, { productName, locations: Map<location, quantity> }>
            let inventory = new Map();
            
            // Available locations
            const locations = ["Supplier", "Warehouse", "Retailer"];
            const DB_KEY = 'inventoryChain'; // Key for localStorage

            // --- DOM ELEMENTS ---
            const addItemForm = document.getElementById('add-item-form');
            const moveItemForm = document.getElementById('move-item-form');
            const clearDbButton = document.getElementById('clear-db-button');
            const inventoryDisplay = document.getElementById('inventory-display');
            const ledgerDisplay = document.getElementById('ledger-display');
            const moveProductIdSelect = document.getElementById('move-product-id');
            const errorToast = document.getElementById('error-toast');
            const errorMessage = document.getElementById('error-message');

            // --- CORE LOGIC ---

            /**
             * A simple (and insecure) hash function for demonstration.
             * In a real blockchain, this would be a cryptographic hash like SHA-256.
             */
            const simpleHash = (data) => {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = (hash << 5) - hash + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return '0x' + Math.abs(hash).toString(16);
            };

            /**
             * Creates a new block, adds it to the chain, and saves the chain.
             */
            const createBlock = (transaction) => {
                const index = blockchain.length;
                const timestamp = new Date().toISOString();
                const previousHash = index === 0 ? "0" : blockchain[index - 1].hash;
                
                const block = {
                    index,
                    timestamp,
                    transaction,
                    previousHash,
                };
                
                block.hash = simpleHash(block);
                blockchain.push(block);
                saveBlockchain(); // Save to localStorage on every new block
            };

            /**
             * Processes a transaction, validates it, and updates the inventory state.
             * Returns true on success, false on failure.
             * @param {object} transaction - The transaction object.
             * @param {boolean} [suppressErrors=false] - If true, do not show UI error toasts.
             */
            const processTransaction = (transaction, suppressErrors = false) => {
                const { type, productId, productName, quantity, from, to } = transaction;

                if (type === 'ADD') {
                    // Get or create the product entry
                    if (!inventory.has(productId)) {
                        inventory.set(productId, {
                            productName: productName,
                            locations: new Map()
                        });
                    }
                    const product = inventory.get(productId);
                    
                    // Update the quantity at the 'to' location
                    const currentQty = product.locations.get(to) || 0;
                    product.locations.set(to, currentQty + quantity);
                    return true;
                
                } else if (type === 'MOVE') {
                    // Check if product exists
                    if (!inventory.has(productId)) {
                        showError(`Product ${productId} not found in inventory.`, suppressErrors);
                        return false;
                    }
                    const product = inventory.get(productId);
                    
                    // Check if 'from' location has enough quantity
                    const fromQty = product.locations.get(from) || 0;
                    if (fromQty < quantity) {
                        showError(`Insufficient stock at ${from}. Only ${fromQty} available.`, suppressErrors);
                        return false;
                    }

                    // Perform the move
                    const toQty = product.locations.get(to) || 0;
                    product.locations.set(from, fromQty - quantity);
                    product.locations.set(to, toQty + quantity);
                    return true;
                }
                return false;
            };
            
            // --- EVENT HANDLERS ---

            /**
             * Handles the "Add Item" form submission.
             */
            const handleAddItem = (e) => {
                e.preventDefault();
                const productId = document.getElementById('add-product-id').value;
                const productName = document.getElementById('add-product-name').value;
                const quantity = parseInt(document.getElementById('add-quantity').value, 10);
                const to = document.getElementById('add-to').value;

                if (!productId || !productName || !quantity || quantity <= 0) {
                    showError("Please fill out all fields with valid data.");
                    return;
                }

                const transaction = {
                    type: "ADD",
                    productId,
                    productName,
                    quantity,
                    to
                };

                // Process and create block
                if (processTransaction(transaction)) {
                    createBlock(transaction);
                    // Re-render the UI
                    render();
                }
            };

            /**
             * Handles the "Move Item" form submission.
             */
            const handleMoveItem = (e) => {
                e.preventDefault();
                const productId = document.getElementById('move-product-id').value;
                const quantity = parseInt(document.getElementById('move-quantity').value, 10);
                const from = document.getElementById('move-from').value;
                const to = document.getElementById('move-to').value;

                if (from === to) {
                    showError("'From' and 'To' locations cannot be the same.");
                    return;
                }
                
                if (!productId || !quantity || quantity <= 0) {
                    showError("Please select a product and enter a valid quantity.");
                    return;
                }

                const transaction = {
                    type: "MOVE",
                    productId,
                    quantity,
                    from,
                    to
                };

                // Process and create block
                if (processTransaction(transaction)) {
                    createBlock(transaction);
                    // Re-render the UI
                    render();
                }
            };

            /**
             * Handles clearing the database.
             */
            const handleClearDb = () => {
                localStorage.removeItem(DB_KEY);
                // Re-initialize the app state
                inventory.clear();
                loadBlockchain(); // This will create a new Genesis block
                render();
            };

            // --- RENDERING FUNCTIONS ---
            
            /**
             * Main render function: updates all UI components.
             */
            const render = () => {
                renderInventory();
                renderBlockchain();
                updateMoveProductSelect();
            };

            /**
             * Updates the "Current Inventory" display.
             */
            const renderInventory = () => {
                inventoryDisplay.innerHTML = ''; // Clear current display
                
                if (inventory.size === 0) {
                    inventoryDisplay.innerHTML = '<p class="text-slate-500">No items in inventory. Add some!</p>';
                    return;
                }

                inventory.forEach((product, productId) => {
                    const productCard = document.createElement('div');
                    productCard.className = 'border border-slate-200 rounded-lg p-4 bg-slate-50';
                    
                    let locationsHtml = '';
                    let totalStock = 0;

                    product.locations.forEach((quantity, location) => {
                        if (quantity > 0) {
                            locationsHtml += `
                                <li class="flex justify-between items-center text-sm">
                                    <span class="text-slate-600">${location}:</span>
                                    <span class="font-medium text-slate-800">${quantity} units</span>
                                </li>`;
                            totalStock += quantity;
                        }
                    });

                    if (totalStock === 0) {
                        locationsHtml = '<li class="text-sm text-slate-500">No stock available.</li>';
                    }

                    productCard.innerHTML = `
                        <h3 class="font-semibold text-lg text-indigo-700">${product.productName}</h3>
                        <p class="text-xs text-slate-500 mb-2">${productId}</p>
                        <ul class="space-y-1">
                            ${locationsHtml}
                        </ul>
                        <hr class="my-2">
                        <div class="flex justify-between items-center text-sm font-semibold">
                            <span>Total Stock:</span>
                            <span>${totalStock} units</span>
                        </div>
                    `;
                    inventoryDisplay.appendChild(productCard);
                });
            };

            /**
             * Updates the "Blockchain Ledger" display.
             */
            const renderBlockchain = () => {
                ledgerDisplay.innerHTML = ''; // Clear current display

                // Display in reverse chronological order (newest first)
                [...blockchain].reverse().forEach(block => {
                    const blockElement = document.createElement('div');
                    blockElement.className = 'border border-slate-200 rounded-lg p-4 bg-white shadow-sm';
                    
                    let transactionHtml = '';
                    const { type, productId, productName, quantity, from, to } = block.transaction;

                    if (type === 'ADD') {
                        transactionHtml = `
                            <span class="font-semibold text-green-600">ADD</span>
                            <strong>${quantity}</strong> of
                            <strong>${productName}</strong> (${productId})
                            to <strong>${to}</strong>
                        `;
                    } else if (type === 'MOVE') {
                        transactionHtml = `
                            <span class="font-semibold text-blue-600">MOVE</span>
                            <strong>${quantity}</strong> of
                            <strong>${productId}</strong>
                            from <strong>${from}</strong>
                            to <strong>${to}</strong>
                        `;
                    } else if (type === 'GENESIS') {
                        transactionHtml = `<span class="font-semibold text-slate-500">GENESIS BLOCK</span>`;
                    }

                    blockElement.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-lg text-indigo-700">Block #${block.index}</h4>
                            <span class="text-xs px-2 py-0.5 bg-indigo-100 text-indigo-800 rounded-full">${new Date(block.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <p class="text-sm text-slate-700 mb-3">${transactionHtml}</p>
                        <div class="text-xs text-slate-500 bg-slate-50 p-2 rounded-md">
                            <p class="truncate"><strong>Hash:</strong> ${block.hash}</p>
                            <p class="truncate"><strong>Prev Hash:</strong> ${block.previousHash}</p>
                        </div>
                    `;
                    ledgerDisplay.appendChild(blockElement);
                });
            };

            /**
             * Updates the dropdown in the "Move Item" form.
             */
            const updateMoveProductSelect = () => {
                const currentVal = moveProductIdSelect.value;
                moveProductIdSelect.innerHTML = '<option value="">-- Select Product --</option>'; // Clear
                
                inventory.forEach((product, productId) => {
                    // Only add products that have stock to move
                    let totalStock = 0;
                    product.locations.forEach(qty => totalStock += qty);

                    if (totalStock > 0) {
                        const option = document.createElement('option');
                        option.value = productId;
                        option.textContent = `${product.productName} (${productId})`;
                        if (productId === currentVal) {
                            option.selected = true;
                        }
                        moveProductIdSelect.appendChild(option);
                    }
                });
            };
            
            /**
             * Shows an error message toast.
             * @param {string} message - The error message to display.
             * @param {boolean} [suppress=false] - If true, log to console but don't show toast.
             */
            let errorTimer;
            const showError = (message, suppress = false) => {
                console.error(message);
                if (suppress) {
                    return;
                }
                
                errorMessage.textContent = message;
                errorToast.classList.remove('translate-x-[200%]');
                errorToast.classList.add('translate-x-0');

                clearTimeout(errorTimer);
                errorTimer = setTimeout(() => {
                    errorToast.classList.remove('translate-x-0');
                    errorToast.classList.add('translate-x-[200%]');
                }, 3000);
            };

            // --- INITIALIZATION ---
            
            /**
             * Creates the first block in the chain.
             */
            const createGenesisBlock = () => {
                createBlock({ type: "GENESIS" });
            };

            /**
             * Saves the entire blockchain to localStorage.
             */
            const saveBlockchain = () => {
                try {
                    localStorage.setItem(DB_KEY, JSON.stringify(blockchain));
                } catch (e) {
                    console.error("Failed to save blockchain:", e);
                    showError("Could not save data. LocalStorage may be full.");
                }
            };

            /**
             * Loads the blockchain from localStorage.
             * If no chain exists, it creates the Genesis block.
             */
            const loadBlockchain = () => {
                const savedChain = localStorage.getItem(DB_KEY);
                if (savedChain) {
                    try {
                        blockchain = JSON.parse(savedChain);
                    } catch (e) {
                        console.error("Failed to parse saved blockchain:", e);
                        localStorage.removeItem(DB_KEY); // Clear corrupted data
                        blockchain = [];
                        createGenesisBlock();
                    }
                } else {
                    blockchain = [];
                    createGenesisBlock();
                }
            };

            /**
             * Re-calculates the current inventory state by processing the entire blockchain.
             */
            const rebuildInventoryState = () => {
                inventory.clear(); // Reset the in-memory state
                // Re-process every transaction *except* the Genesis block
                for (let i = 1; i < blockchain.length; i++) {
                    if (blockchain[i] && blockchain[i].transaction) {
                        // Pass 'true' to suppress errors during this rebuild phase
                        processTransaction(blockchain[i].transaction, true); 
                    }
                }
            };

            // Initialize the app
            loadBlockchain();
            rebuildInventoryState();
            render();

            // Bind event listeners
            addItemForm.addEventListener('submit', handleAddItem);
            moveItemForm.addEventListener('submit', handleMoveItem);
            clearDbButton.addEventListener('click', handleClearDb);
        });
    </script>
</body>
</html>

